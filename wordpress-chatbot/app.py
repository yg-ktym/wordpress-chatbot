import streamlit as st
from anthropic import Anthropic

# ページ設定
st.set_page_config(
    page_title="WordPress更新サポート",
    page_icon="📝",
    layout="wide"
)

# APIキーをStreamlit Secretsから取得
try:
    if "ANTHROPIC_API_KEY" in st.secrets:
        ANTHROPIC_API_KEY = st.secrets["ANTHROPIC_API_KEY"]
    else:
        st.error("⚠️ APIキーが設定されていません。管理者に連絡してください。")
        st.stop()
except Exception as e:
    st.error("⚠️ 設定エラーが発生しました。管理者に連絡してください。")
    st.stop()

# WordPress更新マニュアル（完全版）
WORDPRESS_MANUAL = """
# WordPress更新マニュアル

## 第1章：新規投稿の作成

### 1-1. ログイン方法
1. インターネットブラウザ（Chrome、Safari、Edgeなど）を開く
2. WordPressのログイン画面にアクセスする
3. ユーザー名とパスワードを入力
4. 「ログイン」ボタンをクリック

### 1-2. 新規投稿の手順
①左側メニューの「投稿」にマウスを合わせる
②「新規追加」をクリック
③投稿タイトルを入力（「タイトルを追加」の欄）
④本文を入力（下の大きな入力欄）
⑤右上の「公開」をクリック
⑥確認画面で再度「公開」をクリック

※注意：「公開」ボタンを押すまでは下書き状態です

---

## 第2章：文字装飾と見出しの使い方

### 2-1. 基本的な文字装飾
- **太字**：テキストを選択 → ツールバーの「B」をクリック
- *斜体*：テキストを選択 → ツールバーの「I」をクリック
- リンク：テキストを選択 → 🔗アイコンをクリック → URLを入力

### 2-2. 見出しの使い方
**重要：見出しは必ずH2→H3→H4の順序で使う**

①見出しにしたいテキストを入力
②ブロックツールバーの「段落」をクリック
③「見出し」を選択
④H2、H3、H4から選択

**正しい順序：**
```
H2（大見出し）
  └─ H3（中見出し）
      └─ H4（小見出し）
```

**間違った例：**
❌ H2 → H4（H3を飛ばしている）
❌ H3から始める（最初はH2から）

---

## 第3章：投稿の編集と削除

### 3-1. 既存の投稿を編集
①左側メニューの「投稿」→「投稿一覧」
②編集したい投稿のタイトルをクリック
③内容を修正
④右上の「更新」をクリック

### 3-2. 投稿の削除
①「投稿」→「投稿一覧」
②削除したい投稿にマウスを合わせる
③「ゴミ箱へ移動」をクリック

※注意：ゴミ箱に入れてから30日後に完全削除されます

### 3-3. ゴミ箱から復元
①「投稿一覧」の上部「ゴミ箱」タブをクリック
②復元したい投稿にマウスを合わせる
③「復元」をクリック

---

## 第4章：公開設定の変更

### 4-1. 公開中の記事を下書きに戻す
①編集画面を開く
②右側の「投稿」タブを開く（**「ブロック」タブではない**）
③「公開」セクションの「公開」をクリック
④「下書きに切り替え」をクリック
⑤「OK」をクリック

### 4-2. 公開中の記事を非公開にする
①編集画面を開く
②右側の「投稿」タブ
③「公開」セクションの「公開」をクリック
④「公開状態」を「非公開」に変更
⑤「OK」→「更新」をクリック

※注意：「投稿」タブと「ブロック」タブを間違えないように

---

## 第5章：リンクの挿入

### 5-1. テキストリンクの追加
①リンクにしたいテキストを選択
②ツールバーの🔗アイコンをクリック
③URLを入力
④Enterキーを押す

### 5-2. 新しいタブで開く設定
①リンクを設定したテキストをクリック
②🔗アイコンの右の矢印をクリック
③「新しいタブで開く」にチェック
④「送信」または画面外をクリック

---

## 第6章：ブロックの操作

### 6-1. ブロックの移動
①移動したいブロックをクリック
②ブロックツールバーの⬆⬇矢印をクリック
または
③ブロック左側の⋮⋮をドラッグ

### 6-2. ブロックのコピー
①コピーしたいブロックをクリック
②ブロックツールバーの「⋮」→「複製」
または
③ブロックを選択してCommand+D（Mac）/ Ctrl+D（Windows）

### 6-3. ブロックの削除
①削除したいブロックをクリック
②ブロックツールバーの「⋮」→「削除」
または
③ブロックを選択してBackspace/Delete

---

## 第7章：画像のアップロードと管理

### 7-1. 画像のアップロード
①「+」ボタンをクリック
②「画像」ブロックを選択
③「アップロード」をクリック
④パソコンから画像ファイルを選択

**推奨画像サイズ：**
- 横幅：1200px以上
- ファイルサイズ：3MB以下
- 形式：JPG、PNG

### 7-2. 画像の差し替え
①画像ブロックをクリック
②ブロックツールバーの「画像を置き換え」をクリック
③「アップロード」→新しい画像を選択

### 7-3. Alt属性（代替テキスト）の設定
①画像をクリック
②右側の「ブロック」タブを開く
③「Altテキスト（代替テキスト）」欄に説明を入力

**例：**
- 商品画像：「商品名 + 色・サイズなど」
- 人物写真：「〇〇さんの写真」
- 図表：「〇〇の推移グラフ」

※SEO対策に重要です

---

## 第8章：アイキャッチ画像の設定

### 8-1. アイキャッチ画像とは
記事一覧やSNSシェア時に表示されるメイン画像

### 8-2. 設定方法
①編集画面の右側「投稿」タブを開く
②「アイキャッチ画像」セクションを探す
③「アイキャッチ画像を設定」をクリック
④画像をアップロードまたはメディアライブラリから選択
⑤「アイキャッチ画像を設定」をクリック

### 8-3. 変更・削除
①「投稿」タブの「アイキャッチ画像」
②「アイキャッチ画像を置き換え」または「アイキャッチ画像を削除」

---

## よくある質問（Q&A）

### Q1: 画像がアップロードできません
**A:** 以下を確認してください：
- ファイルサイズが3MB以下か
- ファイル形式がJPG、PNG、GIFか
- ファイル名に日本語や特殊文字が含まれていないか

### Q2: 公開した記事が表示されません
**A:** 以下を確認：
- ブラウザのキャッシュをクリア（Ctrl+Shift+R / Command+Shift+R）
- 本当に「公開」状態か確認（「下書き」になっていないか）
- カテゴリーが正しく設定されているか

### Q3: 見出しの順序を間違えました
**A:** 以下の手順で修正：
①該当の見出しブロックをクリック
②ブロックツールバーの見出しレベルを変更
③正しい順序（H2→H3→H4）になるよう調整

### Q4: リンクが新しいタブで開きません
**A:** リンク設定を確認：
①リンクをクリック
②🔗アイコン右の矢印→詳細設定
③「新しいタブで開く」にチェックが入っているか確認

### Q5: 画像が大きすぎて表示が崩れます
**A:** 画像サイズを調整：
①画像ブロックをクリック
②右側「ブロック」タブ
③「画像の寸法」で幅を調整（推奨：800px程度）

### Q6: 下書きを間違って公開してしまいました
**A:** すぐに非公開にできます：
①編集画面を開く
②右側「投稿」タブ→「公開」セクション
③「公開状態」を「下書き」に変更
④「更新」をクリック

### Q7: メディアライブラリの画像を削除したいです
**A:** 以下の手順：
①左側メニュー「メディア」→「ライブラリ」
②削除したい画像をクリック
③右側「完全に削除する」をクリック
④確認画面で「OK」

※注意：記事で使用中の画像を削除すると表示されなくなります

---

## トラブルシューティング

### 画面が真っ白になった
1. ブラウザを再読み込み（F5 / Command+R）
2. ログアウト→再ログイン
3. 別のブラウザで試す

### 保存ボタンが押せない
1. 必須項目（タイトル）が入力されているか確認
2. インターネット接続を確認
3. ブラウザのキャッシュをクリア

### 変更が反映されない
1. 「更新」ボタンを確実にクリックしたか確認
2. ブラウザのキャッシュをクリア
3. 数分待ってから再確認

---

## 重要な注意事項

### やってはいけないこと
❌ テーマファイルを直接編集
❌ プラグインを勝手にインストール
❌ パーマリンク設定を変更
❌ ユーザー権限を変更
❌ データベースを直接操作

### 困ったときは
- まず、このマニュアルで確認
- それでも解決しない場合は、サイト管理者に連絡
- エラーメッセージが出た場合は、スクリーンショットを撮って連絡
"""

# システムプロンプト
SYSTEM_PROMPT = """あなたは「WordPress更新サポート専用エージェント」です。
以下のWordPress更新マニュアルを唯一の正解ルールとして扱い、
マニュアルの内容に基づいて、初心者にも分かるように回答してください。

## あなたの役割
- WordPress初心者の更新担当者をサポートする
- 操作手順を「番号付き」「具体的操作名つき」で説明する
- 専門用語は必ず噛み砕いて説明する
- マニュアルに書かれていない操作は推測で答えない

## 回答ルール
- 画面名・ボタン名は必ずマニュアル表記に合わせる
- 「①②③」のように手順を整理して説明する
- 注意点は「※注意：」として明示する
- できるだけ1回答＝1操作テーマにする
- マニュアルに該当箇所がある場合は「マニュアルの◯章に沿って説明します」と前置きする

## 禁止事項
- マニュアルに記載のないプラグイン・高度な設定の案内
- SEOやデザインの独自判断
- WordPressの仕様変更を前提とした説明
- 「たぶん」「一般的には」などの曖昧表現

## 口調・トーン
- 丁寧で安心感のあるサポート口調
- 初心者を責めない・否定しない
- 「一緒に確認しましょう」というスタンス

以下がWordPress更新マニュアルです：

{manual}
"""

# タイトル
st.title("📝 WordPress更新サポート")
st.markdown("---")

# 使い方説明（サイドバー）
with st.sidebar:
    st.header("💡 使い方")
    st.markdown("""
    このチャットボットは、WordPress更新マニュアルに基づいて質問にお答えします。
    
    **質問例：**
    - 新しい記事を投稿したい
    - 画像をアップロードする方法は？
    - 見出しの使い方を教えて
    - 公開した記事を下書きに戻したい
    - リンクを新しいタブで開くには？
    
    **注意：**
    - マニュアルに記載のない内容はお答えできません
    - プラグインや高度なカスタマイズは対象外です
    """)
    
    st.markdown("---")
    st.caption("Powered by Claude (Anthropic)")

# メインエリア
# チャット履歴の初期化
if "messages" not in st.session_state:
    st.session_state.messages = []

# チャット履歴の表示
for message in st.session_state.messages:
    with st.chat_message(message["role"]):
        st.markdown(message["content"])

# ユーザー入力
if prompt := st.chat_input("質問を入力してください（例：新しい記事を投稿したい）"):
    # ユーザーメッセージを追加
    st.session_state.messages.append({"role": "user", "content": prompt})
    with st.chat_message("user"):
        st.markdown(prompt)
    
    # Claude APIで回答を生成
    with st.chat_message("assistant"):
        message_placeholder = st.empty()
        
        try:
            # Anthropicクライアントの初期化
            client = Anthropic(api_key=ANTHROPIC_API_KEY)
            
            # システムプロンプトにマニュアルを埋め込み
            system_message = SYSTEM_PROMPT.format(manual=WORDPRESS_MANUAL)
            
            # API呼び出し
            response = client.messages.create(
                model="claude-sonnet-4-20250514",
                max_tokens=2000,
                system=system_message,
                messages=[
                    {"role": msg["role"], "content": msg["content"]} 
                    for msg in st.session_state.messages
                ]
            )
            
            # 回答を取得
            assistant_message = response.content[0].text
            
            # 回答を表示
            message_placeholder.markdown(assistant_message)
            
            # セッションに保存
            st.session_state.messages.append({"role": "assistant", "content": assistant_message})
            
        except Exception as e:
            error_message = f"エラーが発生しました: {str(e)}"
            message_placeholder.error(error_message)
            st.session_state.messages.append({"role": "assistant", "content": error_message})

# フッター
st.markdown("---")
st.caption("© 2025 WordPress更新サポート | マニュアルに基づく正確な情報を提供します")
